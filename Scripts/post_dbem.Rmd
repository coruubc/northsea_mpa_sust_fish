---
title: "Post DBEM data analysis for manuscript"
author: "William W.L. Cheung, Juliano Palacios Abrantes, Sarah Roberts"
date: "18/05/2022"
output: html_document
---

---
title: "pre_dbem"
author: "Sarah Roberts"
date: "5/4/2022"
output: html_document
---

```{r}
# For grid estimation and species selection
library(tidyverse)
library(sf)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

# For collaborative ease
library(here)


```



# Test method

Double check the DBEM is doing what we want it to do

```{r read_data}

# MPA test grid
grid_30 <- read_csv(here("./Data/mpa_scenarios/grid_15.csv"))

mpa_grid <- grid_30 %>% 
  select(index = gridID,status,prop)

unique(mpa_grid$status)

# DBEM lat lon
coords <- read.csv(here("./Data/Lon_Lat_DBEM.txt"),header = F) %>% 
  select(index = V1,
         lon = V2,
         lat = V3)


# MCP data
mcp_data <- read.table("/Volumes/Enterprise/Data/northsea_mpa_sust_fish/Raw/C6IPSLtest/600069/600069Catch2020.txt", quote="\"", comment.char="")
colnames(mcp_data) <- c("index","mcp2010")

# ABD data
abd_data <- read.table("/Volumes/Enterprise/Data/northsea_mpa_sust_fish/Raw/C6IPSLtest/600069/600069Abd2020.txt", quote="\"", comment.char="")
colnames(abd_data) <- c("index","abd2010")

# Join both

test_data <-
  mcp_data %>% 
  full_join(abd_data) %>% 
  gather("var","value",mcp2010:abd2010)





```

```{r}

test_data %>% 
  left_join(coords) %>% 
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = value
    )
  ) +
  facet_wrap(~var)

```



```{r}

# Compare catch between surrounding and open ocean
# Surrounding should be more, at least in average
test_data %>% 
  left_join(mpa_grid) %>% 
  mutate(value = ifelse(is.na(value),0,value),
         status = ifelse(is.na(status),"open",status)
         ) %>% 
  group_by(status,var) %>% 
  summarise(
    sum = sum(value, na.rm = T),
    mean = mean(value, na.rm = T),
    n = n()
  )




```


## Where are the protected areas?

```{r}

# Compare catch between surrounding and open ocean
# Surrounding should be more, at least in average

mpa_grid %>% 
  filter(status == "protected") %>% 
  semi_join(test_data) %>% 
  View()



```


```{r check_protected_areas}
taxon_data %>% 
  left_join(mpa_grid) %>% 
  mutate(mcp2010 = ifelse(is.na(mcp2010),0,mcp2010),
         status = ifelse(is.na(status),"oppen",status)
         ) %>% 
  filter(status == "protected")

# No protected areas in data. Because MCP == 0?


```

```{r map_me}

mpa_grid %>% 
  left_join(coords,
            by = "index") %>% 
  # left_join(test_data,
  #           by = "index") %>%
  mutate(status = ifelse(is.na(status),"oppen",status)) %>%
  # filter(!is.na(value)) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = status,
      color = status
    )
  ) + 
  coord_cartesian()


```

