---
title: "Untitled"
author: "Juliano Palacios-Abrantes"
date: '2022-05-03'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(MyFunctions) # JEPA'S standar package

libs <- c("tidyverse","st","sf")

my_lib(libs)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

```

# Species selection

Here we will select the species to model based on the FAO region 27

## Get FAO area

```{r}

# read FAO region 27
# FAO regions
fao_regions <- my_sf("FAO") %>% 
  filter(F_LEVEL == "MAJOR",
         F_CODE == 27)
st_crs(fao_regions) = 4326
  
ggplot(fao_regions) + 
  geom_sf()

```

## Get Spp distributions

```{r}

# Read DBEM coordinates (full)
dbem_coords <- my_path("Spa", "DBEM", name = "complete_lon_lat_dbem.csv", read = T, header = T)

# Create function to crop distribution to north sea
crop_dist <- function(taxonkey){
  
  
  # Reads distribution and crops it to dao
output <- read_distribution(taxonkey, output = "data", root_path = "/Volumes/DATA") %>% 
  bind_cols(dbem_coords) %>% 
  filter(dis >0) %>% 
  filter(f_code == 27)

# Detect stock
if(nrow(output)>0){
  return(data.frame(TaxonKey = taxonkey))
  }else{
    return(data.frame(TaxonKey = NA))
  }
  
}


# Read spp list

# Read species list
SppTaxonName <- read.csv("/Volumes/DATA/JULIANO_NEYMAR/EmergingFish/Data/SAU/SppTaxonName.csv")

# Select species
spp_list <- bind_rows(lapply(SppTaxonName$TaxonKey, crop_dist)) %>% 
  left_join(SppTaxonName) %>% 
  filter(!is.na(TaxonKey)) %>% 
  janitor::clean_names()

write_csv(spp_list,"../Data/nea_spplist.csv")

```




