---
title: "pre_dbem"
author: "Sarah Roberts"
date: "5/4/2022"
output: html_document
---

```{r}
library(sf)
library(spatialEco)
library(ggplot2)
library(tidyverse)
library(geosphere)
library(raster)
library(units)
library(matrixStats)
```


#grid 
for dbem grid that is overlapping FAO27 
randomly select 30% points 
from those 30 points figure out which points are surrounding them (within .75 dec.degrees to get the diagonal)

do the same for the 15% (from the selected 30 - take 50%)

```{r}
fao_27 <- read_sf("../Data/Zone_27.shp")


grid <- read.csv("../Data/Lon_Lat_DBEM.txt", header = FALSE)
colnames(grid) <- c("gridID", "long", "lat")
grid_sp <- st_as_sf(grid, coords = c("long", "lat"), crs = st_crs(fao_27))


sf::sf_use_s2(FALSE)
grid_intersect_27 <- point.in.poly(grid_sp, fao_27)

grid_intersect_27_df <- as.data.frame(grid_intersect_27) 

grid_intersect_27_df <- grid_intersect_27_df[!is.na(grid_intersect_27_df$zone), ] #just zone 27
rm(grid, grid_intersect_27, grid_sp)

ggplot() + 
  geom_sf(data = fao_27) + 
  geom_point(data = grid_intersect_27_df, aes(x = coords.x1, y = coords.x2), size = .2) 
`%!in%` <- Negate(`%in%`)

grid_30 <- grid_intersect_27_df %>% sample_frac(.3)
no_30 <- grid_intersect_27_df  %>% dplyr::filter(gridID %!in% c(grid_30$gridID) )

grid_15 <- grid_30 %>% sample_frac(.5)
no_15 <- grid_intersect_27_df  %>% dplyr::filter(gridID %!in% c(grid_15$gridID) )

grid_30_sp <- st_as_sf(grid_30, coords = c("coords.x1", "coords.x2"), crs = NA)
no_30_sp <- st_as_sf(no_30, coords = c("coords.x1", "coords.x2"), crs = NA)

grid_15_sp <- st_as_sf(grid_15, coords = c("coords.x1", "coords.x2"), crs = NA)
no_15_sp <- st_as_sf(no_15, coords = c("coords.x1", "coords.x2"), crs = NA)
grid_orig <- st_as_sf(grid_intersect_27_df, coords = c("coords.x1", "coords.x2"), crs = NA) #by leaving crs as NA it will calculate distance in decimal degrees



#now we need to get the touching grid cells surrounding the 30 and 15 grid. These will be within .75 dec.degrees 

```

distance - 30 
```{r}
dist_30 <- st_distance(no_30_sp, grid_30_sp)

mins <- rowMins(dist_30, na.rm = T)



dist_30_n <- as.data.frame(mins)
dist_30_n$gridID <- no_30$gridID

n <- 1111398*.75 #1 degree is that many meters (approx) - we want anything 
#this is really big to subset, lets get out smallest distance first 

dist_30_touching <- subset(dist_30_n, dist_30_n$mins < .75)
dist_30_touching <-left_join(dist_30_touching, no_30, by = "gridID")

ggplot() + 
  geom_sf(data = fao_27) +
  geom_point(data = grid_30, aes(x = coords.x1, y = coords.x2), size = .2, colour = "red") + 
  geom_point(data = dist_30_touching, aes(x = coords.x1, y = coords.x2), size = .2, colour = "blue") + 
  coord_sf(xlim=c(-35, -30), ylim=c(40,45), expand = TRUE)

#ookay that seemed to work 
```
#clean up the dataset 
```{r}
dist_30_touching$status <- "surrounding"
dist_30_touching <- dist_30_touching %>% dplyr::select(-mins)
grid_30$status <- "protected"

pt_30 <- rbind(dist_30_touching, grid_30)

grid_30_final <- left_join(grid_intersect_27_df, pt_30, by = c("gridID","coords.x1", "coords.x2"))


#checkit 
ggplot() + 
  geom_sf(data = fao_27) +
  geom_point(data = grid_30_final, aes(x = coords.x1, y = coords.x2, colour = status), size = .2)  + 
  coord_sf(xlim=c(-35, -30), ylim=c(40,45), expand = TRUE)

write.csv(grid_30_final, "../Data/grid_30.csv")
```


distance - 15 
```{r}
dist_15 <- st_distance(no_15_sp, grid_15_sp)

mins <- rowMins(dist_15, na.rm = T)



dist_15_n <- as.data.frame(mins)
dist_15_n$gridID <- no_15$gridID

n <- 1111398*.75 #1 degree is that many meters (approx) - we want anything 
#this is really big to subset, lets get out smallest distance first 

dist_15_touching <- subset(dist_15_n, dist_15_n$mins < .75)
dist_15_touching <-left_join(dist_15_touching, no_15, by = "gridID")

ggplot() + 
  geom_sf(data = fao_27) +
  geom_point(data = grid_15, aes(x = coords.x1, y = coords.x2), size = .2, colour = "red") + 
  geom_point(data = dist_15_touching, aes(x = coords.x1, y = coords.x2), size = .2, colour = "blue") + 
  coord_sf(xlim=c(-35, -30), ylim=c(40,45), expand = TRUE)

#ookay that seemed to work 
```

#clean up the dataset 
```{r}
dist_15_touching$status <- "surrounding"
dist_15_touching <- dist_15_touching %>% dplyr::select(-mins)
grid_15$status <- "protected"

pt_15 <- rbind(dist_15_touching, grid_15)

grid_15_final <- left_join(grid_intersect_27_df, pt_15, by = c("gridID","coords.x1", "coords.x2"))


#checkit 
ggplot() + 
  geom_sf(data = fao_27) +
  geom_point(data = grid_15_final, aes(x = coords.x1, y = coords.x2, colour = status), size = .2)  + 
  coord_sf(xlim=c(-35, -30), ylim=c(40,45), expand = TRUE)

write.csv(grid_15_final, "../Data/grid_15.csv")
```

#add in MPA data 
Note - I found these areas in ArcMap - the MPA shapefile was too big to work with in R - so I selected those that intersect FAO 27, dissolved to one shapefile that includes Marine and Coastal, projected to albers equal area, then calculated the area (in meters). Projected the FAO data into albers equal area as well. I can put those in github, but because they are shapefiles they are kind of big.  

coastal mpa area (meters)- 24315764487.799999 + 93245644267.800003
marine mpa area - 819401638008

FAO area - 14635120094800

so 5.5% of the area is stricly marine protected 819401638008/14635120094800
and 6.4 percent of the area is coastal and marine protected 24315764487.799999 + 93245644267.800003 + 819401638008/14635120094800

I'll do them both to have them both - but we can decide what to use. 

6.4 percent (wich is .2133% of 30 (6.4/30))
```{r}
grid_cm <- grid_30 %>% sample_frac(.2133)
no_cm <- grid_intersect_27_df  %>% dplyr::filter(gridID %!in% c(grid_cm$gridID) )

grid_cm_sp <- st_as_sf(grid_cm, coords = c("coords.x1", "coords.x2"), crs = NA)
no_cm_sp <- st_as_sf(no_cm, coords = c("coords.x1", "coords.x2"), crs = NA)
grid_orig <- st_as_sf(grid_intersect_27_df, coords = c("coords.x1", "coords.x2"), crs = NA) #by leaving crs as NA it will calculate distance in decimal degrees




```

distance - 6.4 percent (wich is .2133% of 30 (6.4/30))
```{r}
dist_cm <- st_distance(no_cm_sp, grid_cm_sp)

mins <- rowMins(dist_cm, na.rm = T)



dist_cm_n <- as.data.frame(mins)
dist_cm_n$gridID <- no_cm$gridID

n <- 1111398*.75 #1 degree is that many meters (approx) - we want anything 
#this is really big to subset, lets get out smallest distance first 

dist_cm_touching <- subset(dist_cm_n, dist_cm_n$mins < .75)
dist_cm_touching <-left_join(dist_cm_touching, no_cm, by = "gridID")

ggplot() + 
  geom_sf(data = fao_27) +
  geom_point(data = grid_cm, aes(x = coords.x1, y = coords.x2), size = .2, colour = "red") + 
  geom_point(data = dist_cm_touching, aes(x = coords.x1, y = coords.x2), size = .2, colour = "blue") + 
  coord_sf(xlim=c(-35, -30), ylim=c(40,45), expand = TRUE)

#ookay that seemed to work 
```
clean up the dataset 
```{r}
dist_cm_touching$status <- "surrounding"
dist_cm_touching <- dist_cm_touching %>% dplyr::select(-mins)
grid_cm$status <- "protected"

pt_cm <- rbind(dist_cm_touching, grid_cm)

grid_cm_final <- left_join(grid_intersect_27_df, pt_cm, by = c("gridID","coords.x1", "coords.x2"))


#checkit 
ggplot() + 
  geom_sf(data = fao_27) +
  geom_point(data = grid_cm_final, aes(x = coords.x1, y = coords.x2, colour = status), size = .2)  + 
  coord_sf(xlim=c(-35, -30), ylim=c(40,45), expand = TRUE)

write.csv(grid_cm_final, "../Data/grid_cm6point4.csv")
```

#5.5 percent (wich is .1833% of 30 (5.5/30))
```{r}
grid_m <- grid_30 %>% sample_frac(.1833)
no_m <- grid_intersect_27_df  %>% dplyr::filter(gridID %!in% c(grid_m$gridID) )

grid_m_sp <- st_as_sf(grid_m, coords = c("coords.x1", "coords.x2"), crs = NA)
no_m_sp <- st_as_sf(no_m, coords = c("coords.x1", "coords.x2"), crs = NA)
grid_orig <- st_as_sf(grid_intersect_27_df, coords = c("coords.x1", "coords.x2"), crs = NA) #by leaving crs as NA it will calculate distance in decimal degrees



```

distance - 6.4 percent (wich is .2133% of 30 (6.4/30))
```{r}
dist_m <- st_distance(no_m_sp, grid_m_sp)

mins <- rowMins(dist_m, na.rm = T)



dist_m_n <- as.data.frame(mins)
dist_m_n$gridID <- no_m$gridID

n <- 1111398*.75 #1 degree is that many meters (approx) - we want anything 
#this is really big to subset, lets get out smallest distance first 

dist_m_touching <- subset(dist_m_n, dist_m_n$mins < .75)
dist_m_touching <-left_join(dist_m_touching, no_m, by = "gridID")

ggplot() + 
  geom_sf(data = fao_27) +
  geom_point(data = grid_m, aes(x = coords.x1, y = coords.x2), size = .2, colour = "red") + 
  geom_point(data = dist_m_touching, aes(x = coords.x1, y = coords.x2), size = .2, colour = "blue") + 
  coord_sf(xlim=c(-35, -30), ylim=c(40,45), expand = TRUE)

#ookay that seemed to work 
```
clean up the dataset 
```{r}
dist_m_touching$status <- "surrounding"
dist_m_touching <- dist_m_touching %>% dplyr::select(-mins)
grid_m$status <- "protected"

pt_m <- rbind(dist_m_touching, grid_m)

grid_m_final <- left_join(grid_intersect_27_df, pt_m, by = c("gridID","coords.x1", "coords.x2"))


#checkit 
ggplot() + 
  geom_sf(data = fao_27) +
  geom_point(data = grid_m_final, aes(x = coords.x1, y = coords.x2, colour = status), size = .2)  + 
  coord_sf(xlim=c(-35, -30), ylim=c(40,45), expand = TRUE)

write.csv(grid_m_final, "../Data/grid_m5point5.csv")
```
